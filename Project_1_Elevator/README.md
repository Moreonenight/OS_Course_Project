# 电梯调度项目文档

> 项目选题：处理机管理-电梯调度
> 课程：操作系统
> 指导教师：王冬青

## 一、项目概述

本项目选题为处理机管理-电梯调度。

项目目的有三点，分别是学习调度算法，通过实现电梯调度，体会操作系统调度过程及学习特定环境下多线程编程方法。

项目基本任务是基于线程思想，编写一个电梯调度程序。要求楼层数为20层，有五部互联的电梯。

## 二、需求分析

(1) 每台电梯内设置必要功能键，包括数字键、关门键、开门键、上行键、下行键、报警键、当前电梯的楼层数、上升及下降状态。

(2) 每层楼的每部电梯门口设置有上行和下行按钮和当前电梯状态的数码显示器，且各电梯上行/下行按钮间相互联结。

(3) 通过自行设计的调度算法控制电梯运行，无任务时电梯应保持不动，电梯初始时应位于第一层。

(4) 有基本的图形用户界面。

## 三、调度算法

### 1. 单电梯调度算法

对于每台电梯维护一个停靠列表。电梯不断在停靠列表中的最高层与最低层之间往返移动。如果经过列表中的楼层，就依据特定条件（见下文）决定是否在该楼层停靠，并在停靠后将该楼层从列表中移除。每当用户按下电梯内的按钮，就将该楼层添加到列表中。如果列表中没有楼层，则电梯停靠在最接近的楼层。

这种移动方法符合一般乘客的认知，现实生活中乘客通常不会认为电梯在当前方向上的任务未执行完时会突然变向。

具体实现如下：

 - 每台电梯都是 **MyElevator** 类的一个实例
 
 - 设置 **myList** 数组保存电梯的停靠列表
 
 - 电梯的状态由 **position** , **door_state** 和 **state** 确定。三者分别控制电梯位置（所在层数），电梯门状态及电梯上下行状态
 
| 变量 | 描述 |
| ------ | ------ |
| **position** | 电梯位置。取值范围为 0 到 95 （方便绘图），带余除法除以 5 得到的商加 1 即为电梯所在楼层 |
| **level** | 当前电梯所在楼层，由 **position** 计算得到 |
| **door_state** | 电梯门打开程度。取值范围为 0 到 16 （方便绘图）， 0 代表电梯门完全关闭， 16 代表电梯门完全打开 |
| **state** | 电梯上下行状态， 0 代表不上行也不下行， 1 代表上行， -1 代表下行。注意除非电梯接下来不会上下行，否则电梯静止时状态不为 0  |
| **myList** | 保存电梯需要停靠的楼层列表。不区分上下行（具体由停靠条件确定） |
| **door_open** | 布尔变量，确定电梯当前是正在开门还是正在关门 |

在满足下列条件时，电梯会在该楼层停靠：

- 该楼层在电梯的停靠列表中，且满足下列三个条件之一：
 
 - 该楼层是电梯内部请求
 
 - 该楼层是电梯外部请求，且不与电梯当前运动方向反向
 
 - 电梯已经运动到停靠列表中的最高层或最底层


### 2. 电梯联合调度算法

每当外部按钮被按下时，执行电梯联合调度算法，将相应任务分配给“最接近”（见下文）的电梯。如果“最接近”的电梯发生变化，任务分配也会发生变化。

具体实现如下：

 **MyElevator** 类中实现了 **Calc_Distance** 方法，传入楼层和方向参数可以返回距离。算法会取距离最小的电梯中的一台接取任务。

计算距离的方法如下： 

- 计算电梯停靠列表中的最高层和最低层（如果不存在，记作电梯当前所在楼层），分别保存为 **max_level** 和 **min_level**  

- 如果电梯运行方向与按钮方向同向，且按钮在电梯前方，距离即电梯当前所在层数与按钮层数之差的绝对值

- 如果电梯运行方向与按钮方向同向，且按钮在电梯后方，距离即两倍的最高层与最低层之差减去电梯当前所在层数与按钮层数之差的绝对值（实现细节在此基础上稍有修改）

- 如果电梯运行方向与按钮方向反向，距离即两倍的最高层（或最低层，取决于电梯是上行还是下行）减去电梯当前所在层数与按钮层数之和，再取绝对值

有电梯在该楼层停靠后将从所有电梯停靠列表中删去该楼层（因为“最接近”的电梯可能发生变化，同一个任务可能分配给多台电梯。如果电梯内部的该楼层按钮被按下或是该楼层尚有另一个方向的任务未完成，则不删去该楼层）

## 四、用户界面

![Elevator](Elevator.png)

如图所示。每个按钮上的描述即是该按钮执行的功能。电梯图标位置代表电梯于电梯井中的位置，上方数字代表相应电梯所在层数，三角形代表电梯上下行。

注意开门按钮仅在电梯停靠时才会开门。报警按钮没有实际功能（在现实生活中，按下报警按钮会召来维修人员）。

## 五、项目总结

项目亮点：

 - 用户界面简单易懂，电梯移动用动画展示，比较直观
 
 - 调度算法符合一般乘客对电梯运行方式的预期
 
 - 使用了 **PyQt5** 自带的 **QTimer** 实现了每 **Tick** （1/20 秒）检测电梯状态。**PyQt5** 自带多线程。

项目展望：

 - 用户界面的配色可能需要调整，目前是默认配色
 
 - 调度算法没有考虑载客量，人群聚集的时间段或楼层等。如果是现实生活中使用的调度算法，在这些方面会有相应的改进

## 六、附加说明

### 项目开发环境

 - **Win10 64位**
 
 - **Notepad++**
 
### 使用框架

 - **PyQt5**
 
### 开发语言

 - **Python**
 
### 通过源代码构建可执行程序

首先，需要安装 **PyQt5** （如果手工更改所有 **.py** 文件中 **import** 的包，也可以使用 **PySide2** ）

```
pip install pyqt5

pip install pyqt5-tools
```

然后在项目目录下执行：

```
pyinstaller -F -w -i favicon.ico main.spec
```

即可在 **./dist** 目录下得到可执行程序